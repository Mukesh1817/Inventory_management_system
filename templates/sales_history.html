<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sales History</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sales_history.css') }}" />
</head>
<body>
<div class="dashboard-container">
    <header class="dashboard-header">
        <h1>Sales History</h1>
        <div class="user-info">
            <span>Welcome, {{ session.get('user', 'Guest') }}</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </header>
    <nav class="sidebar">
        <ul>
            <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
            <li><a href="{{ url_for('add_stock') }}">Add Stock</a></li>
            <li class="active"><a href="{{ url_for('sales_history') }}">Sales History</a></li>
        </ul>
    </nav>
    <main class="main-content">
    
        <!-- Filter Toolbar -->
        <div class="filter-toolbar">
            <form method="get" class="filter-form" action="{{ url_for('sales_history') }}">
                <input type="text" name="search" placeholder="Search name, phone, serial" value="{{ search or '' }}" class="filter-input" />
                <select name="size" class="filter-select">
                    <option value="">All Sizes</option>
                    <option value="24" {% if size_filter == '24' %}selected{% endif %}>24</option>
                    <option value="32" {% if size_filter == '32' %}selected{% endif %}>32</option>
                    <option value="43" {% if size_filter == '43' %}selected{% endif %}>43</option>
                    <option value="50" {% if size_filter == '50' %}selected{% endif %}>50</option>
                    <option value="55" {% if size_filter == '55' %}selected{% endif %}>55</option>
                    <option value="65" {% if size_filter == '65' %}selected{% endif %}>65</option>
                </select>

                <!-- Date Input Group -->
                <div class="date-input-group">
                    <input type="date" name="start_date"
                           value="{% if start_date %}{{ start_date[:10] }}{% endif %}"
                           class="filter-input" id="startDate">
                    <span>to</span>
                    <input type="date" name="end_date"
                           value="{% if end_date %}{{ end_date[:10] }}{% endif %}"
                           class="filter-input" id="endDate">
                </div>

                <select name="sort" class="filter-select">
                    <option value="DESC" {% if sort_order == 'DESC' %}selected{% endif %}>Newest First</option>
                    <option value="ASC" {% if sort_order == 'ASC' %}selected{% endif %}>Oldest First</option>
                </select>
                <button type="submit" class="filter-btn">Apply</button>
                {% if date_error %}
                    <div class="error-message">{{ date_error }}</div>
                {% endif %}
            </form>
        </div>

        <div class="tabs">
            <button onclick="showTab('tv-tab')" class="tab-button {% if not request.args.get('tab') or request.args.get('tab') == 'tv' %}active{% endif %}">Television Sales</button>
            <button onclick="showTab('accessory-tab')" class="tab-button {% if request.args.get('tab') == 'accessory' %}active{% endif %}">Accessory Sales</button>
        </div>

        <!-- Television Sales Tab -->
        <div id="tv-tab" class="tab-content" {% if not request.args.get('tab') or request.args.get('tab') == 'tv' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
            <div class="export-buttons">
                <a href="{{ url_for('export_tv_sales') }}?start_date={{ start_date }}&end_date={{ end_date }}&search={{ search|urlencode }}&size={{ size_filter }}" class="export-btn">Export TV Sales</a>
            </div>
            <div class="inventory-table">
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Brand</th>
                            <th>Size</th>
                            <th>Serial</th>
                            <th>Date</th>
                            <th>Price</th>
                            <th>Warranty</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if tv_sales %}
                            {% for sale in tv_sales %}
                                <tr>
                                    <td>{{ sale.type }}</td>
                                    <td>{{ sale.name }}</td>
                                    <td>{{ sale.phone or 'N/A' }}</td>
                                    <td>{{ sale.brand }}</td>
                                    <td>{{ sale.size }}</td>
                                    <td>{{ sale.serial_number }}</td>
                                    <td>{{ sale.sale_date.strftime('%d/%m/%Y') if sale.sale_date else 'N/A' }}</td>
                                    <td>{{ sale.warranty or 'N/A' }}</td>
                                    <td>₹{{ sale.price }}</td>
                                    <td>
                                        <form method="post" action="{{ url_for('delete_sale') }}" onsubmit="return confirm('Are you sure you want to delete this sale?');">
                                            <input type="hidden" name="sale_id" value="{{ sale.id }}">
                                            <input type="hidden" name="sale_type" value="{{ 'b2b_tv' if sale.type == 'B2B' else 'b2c_tv' }}">
                                            <button type="submit" class="delete-btn">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="9" style="text-align:center;">No TV sales found</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Accessory Sales Tab -->
        <div id="accessory-tab" class="tab-content" {% if request.args.get('tab') == 'accessory' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
            <div class="export-buttons">
                <a href="{{ url_for('export_accessory_sales') }}?start_date={{ start_date }}&end_date={{ end_date }}&search={{ search|urlencode }}" class="export-btn">Export Accessory Sales</a>
            </div>
            <div class="inventory-table">
                <table>
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Phone</th>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Labour</th>
                            <th>Date</th>
                            <th>Price</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if accessory_sales %}
                            {% for a in accessory_sales %}
                                <tr>
                                    <td>{{ a.customer_name }}</td>
                                    <td>{{ a.phone }}</td>
                                    <td>{{ a.item_name }}</td>
                                    <td>{{ a.quantity }}</td>
                                    <td>
                                        {% if a.labour_name == 'prabhu' %}Prabhu
                                        {% elif a.labour_name == 'tamil' %}Tamil
                                        {% else %}Main Stock
                                        {% endif %}
                                    </td>
                                    <td>{{ a.sale_date.strftime('%d/%m/%Y') if a.sale_date else 'N/A' }}</td>
                                    <td>₹{{ a.price }}</td>
                                    <td>
                                        <form method="post" action="{{ url_for('delete_sale') }}" onsubmit="return confirm('Are you sure you want to delete this sale?');">
                                            <input type="hidden" name="sale_id" value="{{ a.id }}">
                                            <input type="hidden" name="sale_type" value="b2c_accessory">
                                            <button type="submit" class="delete-btn">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="8" style="text-align:center;">No accessory sales found</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script>
    function logout() {
        window.location.href = "{{ url_for('logout') }}";
    }

    function showTab(tabId) {
        try {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');

            const tabParam = tabId === 'tv-tab' ? 'tv' : 'accessory';
            const url = new URL(window.location.href);
            url.searchParams.set('tab', tabParam);
            window.history.replaceState(null, '', url.toString());
        } catch (e) {
            console.error("Error showing tab:", e);
        }
    }

    window.onload = () => {
        try {
            const tab = new URLSearchParams(window.location.search).get("tab");
            if (tab === "accessory") showTab("accessory-tab");
            else showTab("tv-tab");
        } catch (e) {
            console.error("Error loading tab:", e);
        }
    };
</script>
</body>
</html>